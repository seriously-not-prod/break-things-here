name: CI - PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-issue-hierarchy:
    name: Validate Issue Hierarchy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Extract issue numbers from PR
        id: extract-issues
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Extract issue numbers from PR body and title
          # Matches: #123, Closes #123, Fixes #456, etc.
          
          ISSUES=$(echo "$PR_TITLE $PR_BODY" | grep -oE '#[0-9]+' | sed 's/#//' | sort -u | tr '\n' ' ')
          
          if [ -z "$ISSUES" ]; then
            echo "⚠️  No issue references found in PR"
            echo "issue_numbers=" >> $GITHUB_OUTPUT
            echo "has_issues=false" >> $GITHUB_OUTPUT
          else
            echo "Found issue references: $ISSUES"
            echo "issue_numbers=$ISSUES" >> $GITHUB_OUTPUT
            echo "has_issues=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate issue hierarchy
        if: steps.extract-issues.outputs.has_issues == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x scripts/validate-issue-hierarchy.js
          node scripts/validate-issue-hierarchy.js ${{ steps.extract-issues.outputs.issue_numbers }}
      
      - name: Comment on PR (Success)
        if: success() && steps.extract-issues.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **Issue Hierarchy Validation Passed**\n\nAll referenced issues follow the proper hierarchy:\n```\nTheme → User Story → Task → Sub-Task\n```'
            })
      
      - name: Comment on PR (Failure)
        if: failure() && steps.extract-issues.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Issue Hierarchy Validation Failed**\n\nOne or more referenced issues do not follow the required hierarchy.\n\n**Required hierarchy:**\n```\nTheme (standalone issue)\n└── User Story (sub-issue of Theme)\n    └── Task (sub-issue of User Story)\n        └── Sub-Task (sub-issue of Task)\n```\n\n**How to fix:**\n1. Navigate to the parent issue\n2. Click "Create sub-issue" at the bottom of the issue description\n3. Or use the dropdown next to "Create sub-issue" → "Add existing issue"\n\nSee the workflow logs for detailed validation errors.'
            })
      
      - name: Warning for PRs without issue references
        if: steps.extract-issues.outputs.has_issues == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️  **Warning: No Issue References Found**\n\nThis PR does not reference any issues. All work should be tracked through issues.\n\n**Please:**\n- Reference the issue in the PR description (e.g., `Closes #123`)\n- Or add issue reference to the PR title\n- Ensure the issue follows proper hierarchy\n\n**Required hierarchy:**\n```\nTheme → User Story → Task → Sub-Task\n```'
            })
            core.warning('No issue references found in PR')
  
  validate-commit-messages:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate commit messages
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "Validating commit messages..."
          
          # Get all commits in this PR
          COMMITS=$(git log --format="%H" $BASE_SHA..$HEAD_SHA)
          
          ERRORS=0
          
          for COMMIT in $COMMITS; do
            MESSAGE=$(git log --format=%s -n 1 $COMMIT)
            FULL_MESSAGE=$(git log --format=%B -n 1 $COMMIT)
            
            echo ""
            echo "Checking commit: $COMMIT"
            echo "Message: $MESSAGE"
            
            # Check for issue reference (#123)
            if ! echo "$FULL_MESSAGE" | grep -qE '#[0-9]+'; then
              echo "❌ FAIL: No issue reference found (must include #123)"
              ERRORS=$((ERRORS + 1))
            else
              echo "✅ Has issue reference"
            fi
            
            # Check conventional commit format
            if ! echo "$MESSAGE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+'; then
              echo "⚠️  WARNING: Not conventional commit format (type(scope): description)"
            fi
            
            # Check length
            if [ ${#MESSAGE} -gt 72 ]; then
              echo "⚠️  WARNING: Subject line longer than 72 characters"
            fi
          done
          
          echo ""
          echo "═══════════════════════════════════════"
          
          if [ $ERRORS -gt 0 ]; then
            echo "❌ Validation failed: $ERRORS commit(s) missing issue references"
            echo ""
            echo "All commits must reference an open GitHub issue."
            echo "Example: feat(auth): add login validation #123"
            exit 1
          else
            echo "✅ All commits have issue references"
            exit 0
          fi
      
      - name: Comment on PR (Commit validation failed)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Commit Message Validation Failed**\n\nOne or more commits are missing issue references.\n\n**Required format:**\n```\ntype(scope): description #123\n```\n\n**Example:**\n```\nfeat(auth): add login validation #123\nfix(payment): resolve checkout crash #456\n```\n\n**Allowed types:** feat, fix, docs, style, refactor, test, chore\n\nEvery commit must reference an open GitHub issue.\n\nSee the workflow logs for details.'
            })
